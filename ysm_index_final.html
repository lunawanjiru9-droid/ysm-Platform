<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YSM - YouTube Subs Monetization</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.youtube.com/iframe_api"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-storage-compat.js"></script>
    
    <style>
        /* Your existing CSS remains unchanged */
        :root {
            --primary-red: #E50914;
            --dark-red: #b80710;
            --black: #000000;
            --dark-gray: #0a0a0a;
            --medium-gray: #1a1a1a;
            --light-gray: #333333;
            --white: #ffffff;
            --success: #00ff00;
            --warning: #ffa500;
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--black);
            color: var(--white);
            min-height: 100vh;
            line-height: 1.6;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Your existing CSS continues here... */
        /* (All your existing CSS styles remain the same) */
    </style>
</head>
<body>

<!-- Loader injected -->
<style>
#loader-wrap{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;background:#fff;z-index:99999;transition:opacity 1.5s ease}
.play-icon{width:96px;height:96px;display:flex;align-items:center;justify-content:center}
.play-icon svg{width:64px;height:64px;fill:#FF0000}
.loader-bar{width:240px;height:6px;background:rgba(0,0,0,0.08);border-radius:6px;margin-top:18px;overflow:hidden;position:relative}
.loader-progress{position:absolute;left:0;height:100%;background:#FF0000;transition:width 0.2s linear}
</style>
<div id="loader-wrap">
  <div class="play-icon"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 22V2l18 10L3 22z"></path></svg></div>
  <div class="loader-bar"><div id="loader-progress" class="loader-progress" style="width:0%"></div></div>
</div>
<script>
(function(){
  const loader = document.getElementById('loader-wrap'); const prog = document.getElementById('loader-progress');
  if(!loader || !prog) return;
  let progress=0, iv=null;
  function update(p){ const clamped=Math.max(0,Math.min(100,p)); prog.style.width=clamped+'%'; }
  function finish(){ if(iv) clearInterval(iv); loader.style.opacity='0'; setTimeout(()=>{ loader.style.display='none'; },1500); }
  iv = setInterval(()=>{ if(progress<60) progress+=Math.random()*2+0.6; else progress+=Math.random()*3+1; update(progress); if(progress>=100) finish(); },120);
  setTimeout(()=>{ if(typeof firebase!=='undefined' && firebase.auth){ finish(); } },3000);
  setTimeout(()=>{ if(progress<100) finish(); },8000);
})();
</script>

    <!-- Loading Spinner -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Processing...</p>
    </div>

    <!-- Hidden Admin Access -->
    <button class="admin-access" onclick="showPage('admin-login-page')" title="Admin Access"></button>

    <!-- Landing Page -->
    <div id="landing-page" class="page active">
        <!-- Your existing landing page content remains the same -->
    </div>

    <!-- Registration Page -->
    <div id="register-page" class="page form-container">
        <!-- Your existing registration form remains the same -->
    </div>

    <!-- OTP Verification Page -->
    <div id="otp-verification-page" class="page form-container">
        <!-- Your existing OTP verification form remains the same -->
    </div>

    <!-- Login Page -->
    <div id="login-page" class="page form-container">
        <!-- Your existing login form remains the same -->
    </div>

    <!-- KYC Page -->
    <div id="kyc-page" class="page form-container">
        <!-- Your existing KYC form remains the same -->
    </div>

    <!-- KYC Pending Page -->
    <div id="kyc-pending-page" class="page form-container">
        <!-- Your existing KYC pending page remains the same -->
    </div>

    <!-- User Dashboard -->
    <div id="user-dashboard" class="page dashboard">
        <!-- Your existing user dashboard remains the same -->
    </div>

    <!-- Admin Login -->
    <div id="admin-login-page" class="page form-container">
        <!-- Your existing admin login form remains the same -->
    </div>

    <!-- Admin Dashboard -->
    <div id="admin-dashboard" class="page dashboard">
        <!-- Your existing admin dashboard remains the same -->
    </div>

    <!-- Withdrawal Modal -->
    <div id="withdraw-modal" class="page form-container" style="display: none;">
        <!-- Your existing withdrawal modal remains the same -->
    </div>

    <!-- Change PIN Modal -->
    <div id="change-pin-modal" class="page form-container" style="display: none;">
        <!-- Your existing change PIN modal remains the same -->
    </div>

    <!-- Chat Modal -->
    <div id="chat-modal" class="page form-container" style="display: none; max-width: 400px; height: 500px; display: flex; flex-direction: column;">
        <!-- Your existing chat modal remains the same -->
    </div>

    <script>
        // ==================== FIREBASE CONFIGURATION ====================
        const firebaseConfig = {
            apiKey: "AIzaSyDOKJQayF5j5xCp6LVZEEFFJH0QiQtezgg",
            authDomain: "ysm-platform-6ef20.firebaseapp.com",
            projectId: "ysm-platform-6ef20",
            storageBucket: "ysm-platform-6ef20.appspot.com",
            messagingSenderId: "485407332553",
            appId: "1:485407332553:web:77bd1bf2b3146486e51518"
        };

        // Initialize Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error("Firebase initialization error:", error);
        }

        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage();

        // ==================== APPLICATION STATE ====================
        let currentUser = null;
        let userId = null;

        // Tier system configuration
        const tierSystem = {
            "115.38": { adsPerDay: 8, payPerAd: 0.48, daily: 3.85, monthly: 115.38, sixMonth: 692.31, oneYear: 1384.62 },
            "192.31": { adsPerDay: 10, payPerAd: 0.64, daily: 6.41, monthly: 192.31, sixMonth: 1153.85, oneYear: 2307.69 },
            "269.23": { adsPerDay: 12, payPerAd: 0.75, daily: 8.97, monthly: 269.23, sixMonth: 1615.38, oneYear: 3230.77 },
            "307.69": { adsPerDay: 13, payPerAd: 0.79, daily: 10.26, monthly: 307.69, sixMonth: 1846.15, oneYear: 3692.31 },
            "461.54": { adsPerDay: 15, payPerAd: 1.03, daily: 15.38, monthly: 461.54, sixMonth: 2769.23, oneYear: 5538.46 },
            "615.38": { adsPerDay: 17, payPerAd: 1.21, daily: 20.51, monthly: 615.38, sixMonth: 3692.31, oneYear: 7384.62 },
            "769.23": { adsPerDay: 18, payPerAd: 1.43, daily: 25.64, monthly: 769.23, sixMonth: 4615.38, oneYear: 9230.77 },
            "923.08": { adsPerDay: 20, payPerAd: 1.54, daily: 30.77, monthly: 923.08, sixMonth: 5538.46, oneYear: 11076.92 },
            "1692.31": { adsPerDay: 25, payPerAd: 2.26, daily: 56.41, monthly: 1692.31, sixMonth: 10153.85, oneYear: 20307.69 },
            "2461.54": { adsPerDay: 30, payPerAd: 2.74, daily: 82.05, monthly: 2461.54, sixMonth: 14769.23, oneYear: 29538.46 },
            "3230.77": { adsPerDay: 35, payPerAd: 3.08, daily: 107.69, monthly: 3230.77, sixMonth: 19384.62, oneYear: 38769.23 },
            "4000.00": { adsPerDay: 40, payPerAd: 3.33, daily: 133.33, monthly: 4000.00, sixMonth: 24000.00, oneYear: 48000.00 },
            "4615.38": { adsPerDay: 45, payPerAd: 3.42, daily: 153.85, monthly: 4615.38, sixMonth: 27692.31, oneYear: 55384.62 }
        };

        // ==================== FIXED AUTH STATE LISTENER ====================
        firebase.auth().onAuthStateChanged(async (user) => {
            try {
                if (user) {
                    const uid = user.uid;
                    const userRef = db.collection('users').doc(uid);
                    const doc = await userRef.get();
                    
                    if (!doc.exists) {
                        // Create user document if it doesn't exist
                        await userRef.set({ 
                            name: user.displayName || '', 
                            email: user.email || '', 
                            tier: '115.38', 
                            kycStatus: 'unverified', 
                            role: 'user', 
                            createdAt: new Date().toISOString(),
                            balance: 0,
                            pendingBalance: 0,
                            referralEarnings: 0,
                            dailyWatchCount: 0,
                            totalReferrals: 0,
                            referralCode: generateReferralCode(),
                            withdrawalPin: generatePIN()
                        });
                    }
                    
                    const freshDoc = await userRef.get();
                    const userData = freshDoc.exists ? freshDoc.data() : {};
                    
                    currentUser = { 
                        id: uid, 
                        name: userData.name || user.displayName || '', 
                        email: userData.email || user.email || '', 
                        tier: userData.tier || '115.38', 
                        kycStatus: userData.kycStatus || 'unverified', 
                        role: userData.role || 'user', 
                        balance: userData.balance || 0,
                        pendingBalance: userData.pendingBalance || 0,
                        referralEarnings: userData.referralEarnings || 0,
                        dailyWatchCount: userData.dailyWatchCount || 0,
                        totalReferrals: userData.totalReferrals || 0,
                        referralCode: userData.referralCode || '',
                        withdrawalPin: userData.withdrawalPin || '',
                        tierData: tierSystem[userData.tier] || tierSystem['115.38']
                    };
                    
                    // Route user based on role and KYC status
                    if (currentUser.role === 'admin') { 
                        showPage('admin-dashboard');
                        loadAdminStats();
                    } else {
                        if (currentUser.kycStatus === 'approved') { 
                            showPage('user-dashboard');
                            loadUserDashboard();
                        } else if (currentUser.kycStatus === 'pending') { 
                            showPage('kyc-pending-page');
                        } else { 
                            showPage('kyc-page');
                        }
                    }
                } else {
                    currentUser = null;
                    showPage('landing-page');
                }
            } catch (err) { 
                console.error('Auth state listener error:', err);
                showPage('landing-page');
            }
        });

        // ==================== FIXED UI FUNCTIONS ====================
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.style.display = 'none';
            });
            document.getElementById(pageId).style.display = 'block';
            
            // Reset scroll position
            window.scrollTo(0, 0);
        }

        function showError(message) {
            alert('❌ ' + message);
        }

        function showSuccess(message) {
            alert('✅ ' + message);
        }

        // ==================== FIXED AUTHENTICATION FUNCTIONS ====================
        async function registerUser() {
            try {
                const name = document.getElementById('reg-name')?.value?.trim();
                const email = document.getElementById('reg-email')?.value?.trim();
                const password = document.getElementById('reg-password')?.value;
                const phone = document.getElementById('reg-phone')?.value?.trim();
                const country = document.getElementById('reg-country')?.value;
                
                if (!name || !email || !password || !phone || !country) { 
                    alert('Please fill all fields'); 
                    return; 
                }
                
                showLoading();
                const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                if (!user) throw new Error('User creation failed');
                
                // Create user document in Firestore
                await db.collection('users').doc(user.uid).set({
                    name: name, 
                    email: email, 
                    phone: phone,
                    country: country,
                    tier: '115.38', 
                    kycStatus: 'unverified', 
                    role: 'user', 
                    balance: 0,
                    pendingBalance: 0,
                    referralEarnings: 0,
                    dailyWatchCount: 0,
                    totalReferrals: 0,
                    referralCode: generateReferralCode(),
                    withdrawalPin: generatePIN(),
                    createdAt: new Date().toISOString(),
                    canEarn: false
                });
                
                // Send email verification
                try { 
                    await user.sendEmailVerification(); 
                    alert('Verification email sent.'); 
                } catch (e) { 
                    console.warn('Email verification failed', e); 
                }
                
                alert('Account created successfully. Please complete KYC verification.');
                showPage('kyc-page');
            } catch (err) { 
                console.error('Registration error:', err);
                alert('Registration failed: ' + (err.message || err)); 
            } finally {
                hideLoading();
            }
        }

        async function loginUser() {
            try {
                const email = document.getElementById('login-email')?.value?.trim();
                const password = document.getElementById('login-password')?.value;
                
                if (!email || !password) { 
                    alert('Enter email & password'); 
                    return; 
                }
                
                showLoading();
                await firebase.auth().signInWithEmailAndPassword(email, password);
                // Auth state listener will handle redirection
            } catch (err) { 
                console.error('Login error:', err);
                alert('Login failed: ' + (err.message || err)); 
            } finally {
                hideLoading();
            }
        }

        async function logout() {
            try {
                await firebase.auth().signOut();
                showPage('landing-page');
                showSuccess('Signed out successfully');
            } catch (error) {
                console.error('Logout error:', error);
                showError('Logout failed');
            }
        }

        // ==================== FIXED KYC FUNCTIONS ====================
        async function submitKYC() {
            try {
                const name = document.getElementById('kyc-name')?.value?.trim();
                const idType = document.getElementById('kyc-id-type')?.value;
                const idNumber = document.getElementById('kyc-id-number')?.value?.trim();
                const front = document.getElementById('kyc-front')?.files?.[0];
                const back = document.getElementById('kyc-back')?.files?.[0];
                const selfie = document.getElementById('kyc-selfie')?.files?.[0];
                const address = document.getElementById('kyc-address')?.files?.[0];
                
                if (!name || !idType || !idNumber || !front || !back || !selfie || !address) { 
                    alert('Please complete KYC form and upload all required files'); 
                    return; 
                }
                
                const user = firebase.auth().currentUser;
                if (!user) { 
                    alert('Not authenticated. Please log in again.'); 
                    return; 
                }
                
                showLoading();
                
                // Upload files to Firebase Storage
                const frontRef = storage.ref(`user_uploads/${user.uid}/kyc-front-${Date.now()}-${front.name}`);
                const backRef = storage.ref(`user_uploads/${user.uid}/kyc-back-${Date.now()}-${back.name}`);
                const selfieRef = storage.ref(`user_uploads/${user.uid}/kyc-selfie-${Date.now()}-${selfie.name}`);
                const addressRef = storage.ref(`user_uploads/${user.uid}/kyc-address-${Date.now()}-${address.name}`);
                
                await frontRef.put(front);
                await backRef.put(back);
                await selfieRef.put(selfie);
                await addressRef.put(address);
                
                const frontUrl = await frontRef.getDownloadURL();
                const backUrl = await backRef.getDownloadURL();
                const selfieUrl = await selfieRef.getDownloadURL();
                const addressUrl = await addressRef.getDownloadURL();
                
                // Create KYC submission
                await db.collection('kycSubmissions').doc(user.uid).set({
                    userId: user.uid,
                    name: name,
                    idType: idType,
                    idNumber: idNumber,
                    frontImage: frontUrl,
                    backImage: backUrl,
                    selfieImage: selfieUrl,
                    addressImage: addressUrl,
                    status: 'pending',
                    submittedAt: new Date().toISOString()
                });
                
                // Update user KYC status
                await db.collection('users').doc(user.uid).update({ 
                    kycStatus: 'pending',
                    name: name
                });
                
                showSuccess('KYC submitted for review. Please wait for admin approval.');
                showPage('kyc-pending-page');
            } catch (err) { 
                console.error('KYC submission error:', err);
                alert('KYC submission failed: ' + (err.message || err)); 
            } finally {
                hideLoading();
            }
        }

        // ==================== FIXED ADMIN FUNCTIONS ====================
        async function loginAdmin() {
            try {
                const username = document.getElementById('admin-username').value;
                const password = document.getElementById('admin-password').value;

                if (username === 'admin' && password === 'admin123') {
                    showLoading();
                    
                    // Try to sign in with admin credentials
                    try {
                        await auth.signInWithEmailAndPassword('admin@ysm.com', 'admin123');
                    } catch (error) {
                        // If admin user doesn't exist, create it
                        if (error.code === 'auth/user-not-found') {
                            const userCredential = await auth.createUserWithEmailAndPassword('admin@ysm.com', 'admin123');
                            const user = userCredential.user;
                            
                            // Create admin user document
                            await db.collection('users').doc(user.uid).set({
                                name: 'System Administrator',
                                email: 'admin@ysm.com',
                                role: 'admin',
                                kycStatus: 'approved',
                                tier: 'admin',
                                balance: 0,
                                createdAt: new Date().toISOString()
                            });
                        } else {
                            throw error;
                        }
                    }
                    
                    showSuccess('Admin login successful!');
                    showPage('admin-dashboard');
                    loadAdminStats();
                } else {
                    showError('Invalid admin credentials');
                }
            } catch (error) {
                console.error('Admin login error:', error);
                showError('Admin authentication failed: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function loadAdminStats() {
            showAdminSection('admin-stats');
            
            try {
                const usersSnapshot = await db.collection('users').get();
                document.getElementById('total-users').textContent = usersSnapshot.size;
                
                const kycSnapshot = await db.collection('kycSubmissions').where('status', '==', 'pending').get();
                document.getElementById('pending-kyc').textContent = kycSnapshot.size;
                
                const withdrawalsSnapshot = await db.collection('withdrawals').where('status', '==', 'pending').get();
                document.getElementById('pending-withdrawals').textContent = withdrawalsSnapshot.size;
                
                // Calculate totals
                let totalEarnings = 0;
                let totalWithdrawals = 0;
                
                usersSnapshot.forEach(doc => {
                    const user = doc.data();
                    totalEarnings += user.balance + (user.totalWithdrawn || 0);
                });
                
                const approvedWithdrawals = await db.collection('withdrawals').where('status', '==', 'approved').get();
                approvedWithdrawals.forEach(doc => {
                    totalWithdrawals += doc.data().amount;
                });
                
                document.getElementById('total-earnings').textContent = '$' + totalEarnings.toFixed(2);
                document.getElementById('total-withdrawals').textContent = '$' + totalWithdrawals.toFixed(2);
            } catch (error) {
                console.error('Error loading admin stats:', error);
                showError('Failed to load admin statistics');
            }
        }

        async function loadKYCManagement() {
            showAdminSection('kyc-management');
            const kycList = document.getElementById('kyc-list');
            
            try {
                const snapshot = await db.collection('kycSubmissions').where('status', '==', 'pending').get();
                
                if (snapshot.empty) {
                    kycList.innerHTML = '<p style="text-align: center; padding: 40px; color: var(--light-gray);">No pending KYC requests</p>';
                    return;
                }

                let html = '';
                for (const doc of snapshot.docs) {
                    const kyc = doc.data();
                    const userDoc = await db.collection('users').doc(kyc.userId).get();
                    const user = userDoc.data();
                    
                    html += `
                        <div class="user-item">
                            <div>
                                <div style="font-weight: bold;">${kyc.name}</div>
                                <div style="font-size: 0.9rem; color: var(--light-gray);">
                                    ${user.email} • ${kyc.idType} • ${kyc.idNumber}
                                </div>
                                <div style="font-size: 0.8rem; color: var(--warning);">
                                    Submitted: ${new Date(kyc.submittedAt).toLocaleDateString()}
                                </div>
                            </div>
                            <div>
                                <button class="btn btn-success" onclick="approveKYC('${doc.id}')">Approve</button>
                                <button class="btn btn-danger" onclick="rejectKYC('${doc.id}')">Reject</button>
                            </div>
                        </div>
                    `;
                }
                
                kycList.innerHTML = html;
            } catch (error) {
                console.error('Error loading KYC management:', error);
                kycList.innerHTML = `<p style="color: var(--primary-red); text-align: center;">Error loading KYC: ${error.message}</p>`;
            }
        }

        async function approveKYC(kycId) {
            try {
                await db.collection('kycSubmissions').doc(kycId).update({
                    status: 'approved',
                    processedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                await db.collection('users').doc(kycId).update({
                    kycStatus: 'approved',
                    canEarn: true
                });

                showSuccess('KYC approved! User can now earn money.');
                loadKYCManagement();
                loadAdminStats();
            } catch (error) {
                console.error('Error approving KYC:', error);
                showError('Error approving KYC: ' + error.message);
            }
        }

        async function rejectKYC(kycId) {
            try {
                await db.collection('kycSubmissions').doc(kycId).update({
                    status: 'rejected',
                    processedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                await db.collection('users').doc(kycId).update({
                    kycStatus: 'rejected',
                    canEarn: false
                });

                showSuccess('KYC rejected! User must resubmit documents.');
                loadKYCManagement();
                loadAdminStats();
            } catch (error) {
                console.error('Error rejecting KYC:', error);
                showError('Error rejecting KYC: ' + error.message);
            }
        }

        async function loadUserManagement() {
            showAdminSection('user-management');
            const userList = document.getElementById('user-list');
            
            try {
                const snapshot = await db.collection('users').get();
                
                if (snapshot.empty) {
                    userList.innerHTML = '<p style="text-align: center; padding: 40px; color: var(--light-gray);">No users found</p>';
                    return;
                }

                let html = '';
                snapshot.forEach(doc => {
                    const user = doc.data();
                    html += `
                        <div class="user-item">
                            <div>
                                <div style="font-weight: bold;">${user.name}</div>
                                <div style="font-size: 0.9rem; color: var(--light-gray);">
                                    ${user.email} • Tier: $${user.tier} • KYC: ${user.kycStatus}
                                </div>
                                <div style="font-size: 0.8rem; color: var(--warning);">
                                    Balance: $${user.balance || 0}
                                </div>
                            </div>
                            <div class="balance-control">
                                <input type="number" class="balance-input" id="balance-${doc.id}" value="${user.balance || 0}" step="0.01">
                                <button class="btn btn-primary" onclick="updateUserBalance('${doc.id}')">Update</button>
                            </div>
                        </div>
                    `;
                });
                
                userList.innerHTML = html;
            } catch (error) {
                console.error('Error loading user management:', error);
                userList.innerHTML = `<p style="color: var(--primary-red); text-align: center;">Error loading users: ${error.message}</p>`;
            }
        }

        async function updateUserBalance(userId) {
            try {
                const newBalance = parseFloat(document.getElementById(`balance-${userId}`).value);
                
                if (isNaN(newBalance)) {
                    showError('Please enter a valid balance');
                    return;
                }
                
                await db.collection('users').doc(userId).update({
                    balance: newBalance
                });
                
                showSuccess('User balance updated successfully');
            } catch (error) {
                console.error('Error updating user balance:', error);
                showError('Error updating balance: ' + error.message);
            }
        }

        async function loadAdsManagement() {
            showAdminSection('ads-management');
            
            try {
                // Load existing ads
                const snapshot = await db.collection('tasks').where('active', '==', true).get();
                const adsList = document.getElementById('ads-list');
                
                if (snapshot.empty) {
                    adsList.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--light-gray);">No active ads</p>';
                    return;
                }
                
                let html = '<div class="user-list">';
                snapshot.forEach(doc => {
                    const task = doc.data();
                    html += `
                        <div class="user-item">
                            <div>
                                <div style="font-weight: bold;">${task.title}</div>
                                <div style="font-size: 0.9rem; color: var(--light-gray);">
                                    Video ID: ${task.videoId} • Assigned Tiers: ${task.assignedTiers.join(', ')}
                                </div>
                            </div>
                            <div>
                                <button class="btn btn-danger" onclick="deactivateAd('${doc.id}')">Deactivate</button>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                
                adsList.innerHTML = html;
            } catch (error) {
                console.error('Error loading ads management:', error);
                showError('Failed to load ads management');
            }
        }

        async function deactivateAd(adId) {
            try {
                await db.collection('tasks').doc(adId).update({
                    active: false
                });
                
                showSuccess('Ad deactivated successfully');
                loadAdsManagement();
            } catch (error) {
                console.error('Error deactivating ad:', error);
                showError('Error deactivating ad: ' + error.message);
            }
        }

        async function bulkAddVideos() {
            try {
                const linksText = document.getElementById('bulk-youtube-links').value;
                if (!linksText.trim()) {
                    showError('Please enter YouTube links');
                    return;
                }
                
                const links = linksText.split('\n').filter(link => link.trim());
                let addedCount = 0;
                
                for (const link of links) {
                    const videoId = extractVideoId(link);
                    if (videoId) {
                        await db.collection('tasks').add({
                            videoId: videoId,
                            title: `YouTube Video ${videoId}`,
                            active: true,
                            assignedTiers: Object.keys(tierSystem),
                            createdAt: new Date().toISOString()
                        });
                        addedCount++;
                    }
                }
                
                showSuccess(`Added ${addedCount} videos as tasks`);
                document.getElementById('bulk-youtube-links').value = '';
                loadAdsManagement();
            } catch (error) {
                console.error('Error adding videos:', error);
                showError('Error adding videos: ' + error.message);
            }
        }

        function extractVideoId(url) {
            const regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[7].length === 11) ? match[7] : null;
        }

        async function loadWithdrawalManagement() {
            showAdminSection('withdrawal-management');
            const withdrawalList = document.getElementById('withdrawal-list');
            
            try {
                const snapshot = await db.collection('withdrawals').where('status', '==', 'pending').get();
                
                if (snapshot.empty) {
                    withdrawalList.innerHTML = '<p style="text-align: center; padding: 40px; color: var(--light-gray);">No pending withdrawals</p>';
                    return;
                }

                let html = '';
                for (const doc of snapshot.docs) {
                    const withdrawal = doc.data();
                    const userDoc = await db.collection('users').doc(withdrawal.userId).get();
                    const user = userDoc.data();
                    
                    html += `
                        <div class="user-item">
                            <div>
                                <div style="font-weight: bold;">${user.name}</div>
                                <div style="font-size: 0.9rem; color: var(--light-gray);">
                                    ${user.email} • Amount: $${withdrawal.amount} • Method: ${withdrawal.method}
                                </div>
                                <div style="font-size: 0.8rem; color: var(--warning);">
                                    Requested: ${new Date(withdrawal.requestedAt).toLocaleDateString()}
                                </div>
                            </div>
                            <div>
                                <button class="btn btn-success" onclick="approveWithdrawal('${doc.id}')">Approve</button>
                                <button class="btn btn-danger" onclick="rejectWithdrawal('${doc.id}')">Reject</button>
                            </div>
                        </div>
                    `;
                }
                
                withdrawalList.innerHTML = html;
            } catch (error) {
                console.error('Error loading withdrawal management:', error);
                withdrawalList.innerHTML = `<p style="color: var(--primary-red); text-align: center;">Error loading withdrawals: ${error.message}</p>`;
            }
        }

        async function approveWithdrawal(withdrawalId) {
            try {
                const withdrawalDoc = await db.collection('withdrawals').doc(withdrawalId).get();
                const withdrawal = withdrawalDoc.data();
                
                // Update withdrawal status
                await db.collection('withdrawals').doc(withdrawalId).update({
                    status: 'approved',
                    processedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Update user balance
                const userRef = db.collection('users').doc(withdrawal.userId);
                const userDoc = await userRef.get();
                const user = userDoc.data();
                
                await userRef.update({
                    balance: (user.balance || 0) - withdrawal.amount,
                    totalWithdrawn: (user.totalWithdrawn || 0) + withdrawal.amount
                });
                
                showSuccess('Withdrawal approved and processed');
                loadWithdrawalManagement();
                loadAdminStats();
            } catch (error) {
                console.error('Error approving withdrawal:', error);
                showError('Error approving withdrawal: ' + error.message);
            }
        }

        async function rejectWithdrawal(withdrawalId) {
            try {
                await db.collection('withdrawals').doc(withdrawalId).update({
                    status: 'rejected',
                    processedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showSuccess('Withdrawal rejected');
                loadWithdrawalManagement();
                loadAdminStats();
            } catch (error) {
                console.error('Error rejecting withdrawal:', error);
                showError('Error rejecting withdrawal: ' + error.message);
            }
        }

        async function loadTierManagement() {
            showAdminSection('tier-management');
            const tierList = document.getElementById('tier-list');
            
            try {
                let html = '';
                for (const [tier, data] of Object.entries(tierSystem)) {
                    html += `
                        <tr>
                            <td>$${tier}</td>
                            <td>${data.adsPerDay}</td>
                            <td>$${data.payPerAd}</td>
                            <td>$${data.daily}</td>
                            <td>$${data.monthly}</td>
                            <td>$${data.sixMonth}</td>
                            <td>$${data.oneYear}</td>
                        </tr>
                    `;
                }
                
                tierList.innerHTML = html;
            } catch (error) {
                console.error('Error loading tier management:', error);
                tierList.innerHTML = `<tr><td colspan="7" style="text-align: center; color: var(--primary-red);">Error loading tiers: ${error.message}</td></tr>`;
            }
        }

        function showAdminSection(sectionId) {
            document.querySelectorAll('.admin-section').forEach(section => {
                section.style.display = 'none';
            });
            document.getElementById(sectionId).style.display = 'block';
        }

        // ==================== FIXED USER DASHBOARD FUNCTIONS ====================
        async function loadUserDashboard() {
            if (!currentUser) return;
            
            try {
                // Update user data
                const userDoc = await db.collection('users').doc(currentUser.id).get();
                const userData = userDoc.data();
                
                currentUser = { ...currentUser, ...userData };
                
                // Update UI
                document.getElementById('user-name').textContent = currentUser.name;
                document.getElementById('user-tier').textContent = `$${currentUser.tier}`;
                document.getElementById('user-balance').textContent = `$${currentUser.balance?.toFixed(2) || '0.00'}`;
                document.getElementById('user-pending').textContent = `$${currentUser.pendingBalance?.toFixed(2) || '0.00'}`;
                document.getElementById('user-referrals').textContent = currentUser.totalReferrals || 0;
                document.getElementById('user-referral-earnings').textContent = `$${currentUser.referralEarnings?.toFixed(2) || '0.00'}`;
                document.getElementById('referral-code').textContent = currentUser.referralCode || '';
                
                // Load tasks
                await loadTasks();
            } catch (error) {
                console.error('Error loading user dashboard:', error);
                showError('Failed to load dashboard data');
            }
        }

        async function loadTasks() {
            try {
                const tasksContainer = document.getElementById('tasks-container');
                const snapshot = await db.collection('tasks').where('active', '==', true).get();
                
                if (snapshot.empty) {
                    tasksContainer.innerHTML = '<p style="text-align: center; padding: 40px; color: var(--light-gray);">No videos available at the moment. Please check back later.</p>';
                    return;
                }
                
                let html = '';
                snapshot.forEach(doc => {
                    const task = doc.data();
                    html += `
                        <div class="task-card">
                            <div class="video-container">
                                <div id="player-${doc.id}"></div>
                            </div>
                            <div class="task-info">
                                <h3>${task.title || 'YouTube Video'}</h3>
                                <p>Watch this video to earn money</p>
                                <button class="btn btn-primary" onclick="startTask('${doc.id}')">Watch & Earn</button>
                            </div>
                        </div>
                    `;
                });
                
                tasksContainer.innerHTML = html;
            } catch (error) {
                console.error('Error loading tasks:', error);
                document.getElementById('tasks-container').innerHTML = '<p style="text-align: center; padding: 40px; color: var(--primary-red);">Error loading videos</p>';
            }
        }

        function startTask(taskId) {
            // This would initialize the YouTube player and track watch time
            alert('Task started! Watch the video to earn money.');
            // Implementation would track video watch time and credit user when completed
        }

        async function requestWithdrawal() {
            try {
                const amount = parseFloat(document.getElementById('withdraw-amount').value);
                const method = document.getElementById('withdraw-method').value;
                const pin = document.getElementById('withdraw-pin').value;
                
                if (!amount || !method || !pin) {
                    showError('Please fill all fields');
                    return;
                }
                
                if (amount < 10) {
                    showError('Minimum withdrawal is $10');
                    return;
                }
                
                if (amount > currentUser.balance) {
                    showError('Insufficient balance');
                    return;
                }
                
                if (pin !== currentUser.withdrawalPin) {
                    showError('Invalid PIN');
                    return;
                }
                
                showLoading();
                
                // Create withdrawal request
                await db.collection('withdrawals').add({
                    userId: currentUser.id,
                    amount: amount,
                    method: method,
                    status: 'pending',
                    requestedAt: new Date().toISOString()
                });
                
                // Update user balance
                await db.collection('users').doc(currentUser.id).update({
                    balance: currentUser.balance - amount,
                    pendingBalance: (currentUser.pendingBalance || 0) + amount
                });
                
                showSuccess('Withdrawal request submitted. Please wait for admin approval.');
                document.getElementById('withdraw-modal').style.display = 'none';
                loadUserDashboard();
            } catch (error) {
                console.error('Error requesting withdrawal:', error);
                showError('Withdrawal request failed: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // ==================== UTILITY FUNCTIONS ====================
        function generateReferralCode() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        function generatePIN() {
            return Math.floor(1000 + Math.random() * 9000).toString();
        }

        function copyReferralCode() {
            const code = document.getElementById('referral-code').textContent;
            navigator.clipboard.writeText(code);
            showSuccess('Referral code copied!');
        }

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize any event listeners
            console.log('YSM Platform initialized');
        });

    </script>
</body>
</html>
