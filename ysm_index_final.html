<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YSM - YouTube Subs Monetization</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.youtube.com/iframe_api"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-storage-compat.js"></script>
    
    <style>
        /* Your existing CSS remains the same */
        :root {
            --primary-red: #E50914;
            --dark-red: #b80710;
            --black: #000000;
            --dark-gray: #0a0a0a;
            --medium-gray: #1a1a1a;
            --light-gray: #333333;
            --white: #ffffff;
            --success: #00ff00;
            --warning: #ffa500;
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--black);
            color: var(--white);
            min-height: 100vh;
            line-height: 1.6;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Your existing CSS continues here... */
        /* (All your existing CSS styles remain the same) */
    </style>
</head>
<body>

<!-- Simplified Loader -->
<div id="loader-wrap" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;background:#000;z-index:99999;">
  <div style="width:96px;height:96px;display:flex;align-items:center;justify-content:center">
    <i class="fab fa-youtube" style="font-size:64px;color:#FF0000"></i>
  </div>
  <div style="width:240px;height:6px;background:rgba(255,255,255,0.1);border-radius:6px;margin-top:18px;overflow:hidden;">
    <div id="loader-progress" style="height:100%;background:#FF0000;transition:width 0.2s linear;width:0%"></div>
  </div>
  <p style="margin-top:20px;color:#fff">Loading YSM Platform...</p>
</div>

<script>
// Simple loader that doesn't depend on Firebase
setTimeout(() => {
    const loader = document.getElementById('loader-wrap');
    const progress = document.getElementById('loader-progress');
    let width = 0;
    const interval = setInterval(() => {
        width += Math.random() * 10;
        if (width >= 100) {
            width = 100;
            clearInterval(interval);
            setTimeout(() => {
                loader.style.opacity = '0';
                setTimeout(() => loader.style.display = 'none', 500);
            }, 500);
        }
        progress.style.width = width + '%';
    }, 100);
}, 100);
</script>

    <!-- Loading Spinner -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Processing...</p>
    </div>

    <!-- Hidden Admin Access -->
    <button class="admin-access" onclick="showPage('admin-login-page')" title="Admin Access"></button>

    <!-- Landing Page -->
    <div id="landing-page" class="page active">
        <header>
            <div class="container">
                <div class="header-content">
                    <div class="logo">
                        <i class="fab fa-youtube"></i> YSM
                    </div>
                    <div class="auth-buttons">
                        <button class="btn btn-outline" onclick="showPage('login-page')">Login</button>
                        <button class="btn btn-primary" onclick="showPage('register-page')">Join YSM</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Your existing landing page content remains the same -->
        <!-- ... -->
    </div>

    <!-- Registration Page -->
    <div id="register-page" class="page form-container">
        <h2 class="form-title">Join YSM</h2>
        <div class="form-group">
            <input type="text" class="form-control" id="reg-name" placeholder="Full Name" required>
        </div>
        <div class="form-group">
            <input type="email" class="form-control" id="reg-email" placeholder="Email Address" required>
        </div>
        <div class="form-group">
            <input type="tel" class="form-control" id="reg-phone" placeholder="Phone Number" required>
        </div>
        <div class="form-group">
            <select class="form-control" id="reg-country" required>
                <option value="">Select Country</option>
                <option value="us">United States</option>
                <option value="uk">United Kingdom</option>
                <option value="ke">Kenya</option>
                <option value="ng">Nigeria</option>
                <option value="za">South Africa</option>
                <option value="in">India</option>
            </select>
        </div>
        <div class="form-group">
            <input type="password" class="form-control" id="reg-password" placeholder="Create Password" required>
        </div>
        <button class="btn btn-primary btn-3d" style="width: 100%;" onclick="registerUser()">Create Account</button>
        <p style="text-align: center; margin-top: 20px;">
            <a href="#" style="color: var(--primary-red);" onclick="showPage('landing-page')">← Back to Home</a>
        </p>
    </div>

    <!-- Login Page -->
    <div id="login-page" class="page form-container">
        <h2 class="form-title">User Login</h2>
        <div class="form-group">
            <input type="email" class="form-control" id="login-email" placeholder="Email Address" required>
        </div>
        <div class="form-group">
            <input type="password" class="form-control" id="login-password" placeholder="Password" required>
        </div>
        <button class="btn btn-primary btn-3d" style="width: 100%;" onclick="loginUser()">Login</button>
        <p style="text-align: center; margin-top: 20px;">
            <a href="#" style="color: var(--primary-red);" onclick="showPage('landing-page')">← Back to Home</a>
        </p>
    </div>

    <!-- KYC Page -->
    <div id="kyc-page" class="page form-container">
        <h2 class="form-title">KYC Verification - REQUIRED</h2>
        <p style="text-align: center; margin-bottom: 25px; color: var(--warning);">
            All documents are required for verification before you can earn or withdraw
        </p>
        
        <div class="form-group">
            <input type="text" class="form-control" id="kyc-name" placeholder="Full Name" required>
        </div>
        
        <div class="form-group">
            <select class="form-control" id="kyc-id-type" required>
                <option value="">Select ID Type</option>
                <option value="passport">Passport</option>
                <option value="national_id">National ID</option>
                <option value="driving_license">Driving License</option>
            </select>
        </div>
        
        <div class="form-group">
            <input type="text" class="form-control" id="kyc-id-number" placeholder="ID Number" required>
        </div>

        <!-- File Uploads -->
        <div class="form-group">
            <label>ID Front Image *</label>
            <div class="file-upload" onclick="document.getElementById('kyc-front').click()">
                <i class="fas fa-upload" style="font-size: 2rem; margin-bottom: 10px;"></i>
                <p>Click to upload ID Front</p>
                <input type="file" id="kyc-front" style="display: none;" accept="image/*">
                <div id="front-file-name" class="file-name">No file chosen</div>
            </div>
        </div>

        <div class="form-group">
            <label>ID Back Image *</label>
            <div class="file-upload" onclick="document.getElementById('kyc-back').click()">
                <i class="fas fa-upload" style="font-size: 2rem; margin-bottom: 10px;"></i>
                <p>Click to upload ID Back</p>
                <input type="file" id="kyc-back" style="display: none;" accept="image/*">
                <div id="back-file-name" class="file-name">No file chosen</div>
            </div>
        </div>

        <div class="form-group">
            <label>Selfie with ID *</label>
            <div class="file-upload" onclick="document.getElementById('kyc-selfie').click()">
                <i class="fas fa-camera" style="font-size: 2rem; margin-bottom: 10px;"></i>
                <p>Click to upload Selfie with ID</p>
                <input type="file" id="kyc-selfie" style="display: none;" accept="image/*">
                <div id="selfie-file-name" class="file-name">No file chosen</div>
            </div>
        </div>

        <div class="form-group">
            <label>Proof of Address *</label>
            <div class="file-upload" onclick="document.getElementById('kyc-address').click()">
                <i class="fas fa-home" style="font-size: 2rem; margin-bottom: 10px;"></i>
                <p>Click to upload Proof of Address</p>
                <input type="file" id="kyc-address" style="display: none;" accept="image/*">
                <div id="address-file-name" class="file-name">No file chosen</div>
            </div>
        </div>

        <button class="btn btn-primary btn-3d" style="width: 100%;" onclick="submitKYC()">Submit KYC Verification</button>
    </div>

    <!-- KYC Pending Page -->
    <div id="kyc-pending-page" class="page form-container">
        <div style="text-align: center; padding: 40px;">
            <div class="glassmorphism" style="padding: 30px; border-radius: 15px; margin: 20px 0;">
                <h2>🕒 KYC Verification Pending</h2>
                <p>Your documents are under review by our admin team.</p>
                <div class="badge badge-pending" style="margin-top: 15px;">Under Review</div>
            </div>
            <p style="margin-top: 20px; color: var(--light-gray);">
                You will gain full access once your KYC is approved. This usually takes 24-48 hours.
            </p>
            <button class="btn btn-outline" style="margin-top: 20px;" onclick="logout()">Logout</button>
        </div>
    </div>

    <!-- User Dashboard -->
    <div id="user-dashboard" class="page dashboard">
        <div class="top-bar">
            <div style="display: flex; align-items: center; gap: 15px;">
                <div id="user-avatar" class="glassmorphism" style="width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 1.1rem;">U</div>
                <div>
                    <div id="user-display-name" style="font-weight: bold;">User</div>
                    <div style="font-size: 0.8rem; color: var(--light-gray);">
                        <span id="user-tier-display">Tier</span> • 
                        <span id="kyc-status" class="badge badge-pending">KYC</span>
                    </div>
                </div>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-outline" style="padding: 8px 12px;" onclick="toggleNotifications()">
                    <i class="fas fa-bell"></i>
                </button>
                <button class="btn btn-outline" onclick="logout()">Logout</button>
            </div>
        </div>

        <div class="dashboard-content" id="dashboard-home">
            <!-- Wallet Summary -->
            <div class="wallet-card">
                <h3>💰 Your YSM Wallet</h3>
                <div class="wallet-balance" id="user-balance">$0.00</div>
                <div style="display: flex; justify-content: space-between; margin: 15px 0;">
                    <div>
                        <div style="font-size: 0.9rem; color: var(--light-gray);">Pending</div>
                        <div style="font-weight: bold;" id="user-pending">$0.00</div>
                    </div>
                    <div>
                        <div style="font-size: 0.9rem; color: var(--light-gray);">Referral Earnings</div>
                        <div style="font-weight: bold;" id="user-referral">$0.00</div>
                    </div>
                </div>
                
                <button class="btn btn-primary btn-3d" style="width: 100%; margin-top: 20px; padding: 15px;" onclick="showWithdrawModal()">
                    Request Withdrawal
                </button>
            </div>

            <!-- Tasks Section -->
            <div style="padding: 20px;">
                <h3 style="margin-bottom: 20px;">🎬 Available Tasks</h3>
                <div id="tasks-container">
                    <div class="task-card">
                        <div class="video-container">
                            <iframe src="https://www.youtube.com/embed/dQw4w9WgXcQ" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                        </div>
                        <h4>Sample Video Task</h4>
                        <p>Watch this video to earn $0.50</p>
                        <button class="subscribe-btn" onclick="startTask('sample')">Watch & Earn</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Login -->
    <div id="admin-login-page" class="page form-container">
        <h2 class="form-title">Admin Login</h2>
        <div class="form-group">
            <input type="text" class="form-control" id="admin-username" placeholder="Admin Username" value="admin" required>
        </div>
        <div class="form-group">
            <input type="password" class="form-control" id="admin-password" placeholder="Admin Password" value="admin123" required>
        </div>
        <button class="btn btn-primary btn-3d" style="width: 100%;" onclick="loginAdmin()">Access Admin Panel</button>
        <p style="text-align: center; margin-top: 20px;">
            <a href="#" style="color: var(--primary-red);" onclick="showPage('landing-page')">← Back to Home</a>
        </p>
    </div>

    <!-- Admin Dashboard -->
    <div id="admin-dashboard" class="page dashboard">
        <div class="top-bar">
            <div style="display: flex; align-items: center; gap: 15px;">
                <div class="glassmorphism" style="width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 1.1rem;">A</div>
                <div>
                    <div style="font-weight: bold;">YSM Admin Panel</div>
                    <div style="font-size: 0.8rem; color: var(--light-gray);">Full System Access</div>
                </div>
            </div>
            <button class="btn btn-outline" onclick="logout()">Logout</button>
        </div>

        <div class="admin-panel">
            <h2 style="margin-bottom: 30px;">👑 Admin Dashboard</h2>
            
            <!-- Admin Navigation -->
            <div class="admin-nav">
                <button class="btn btn-primary" onclick="loadAdminStats()">Dashboard</button>
                <button class="btn btn-primary" onclick="loadKYCManagement()">KYC Management</button>
                <button class="btn btn-primary" onclick="loadUserManagement()">User Management</button>
                <button class="btn btn-primary" onclick="loadAdsManagement()">Ads Management</button>
            </div>
            
            <!-- Dashboard Stats -->
            <div id="admin-stats" class="admin-section admin-grid">
                <div class="admin-card">
                    <h3 style="color: var(--primary-red); margin-bottom: 15px;">📊 Platform Stats</h3>
                    <div style="font-size: 2rem; font-weight: bold; color: var(--success);" id="total-users">0</div>
                    <div>Total Users</div>
                    <div style="margin-top: 15px; font-size: 1.5rem; font-weight: bold; color: var(--warning);" id="pending-kyc">0</div>
                    <div>Pending KYC</div>
                </div>
                
                <div class="admin-card">
                    <h3 style="color: var(--primary-red); margin-bottom: 15px;">💰 Financial Overview</h3>
                    <div style="font-size: 2rem; font-weight: bold; color: var(--success);" id="total-earnings">$0</div>
                    <div>Total Platform Earnings</div>
                </div>
            </div>

            <!-- KYC Management -->
            <div id="kyc-management" class="admin-section admin-card" style="display: none;">
                <h3 style="color: var(--primary-red); margin-bottom: 20px;">🪪 KYC Management</h3>
                <div id="kyc-list">
                    <p style="text-align: center; padding: 40px; color: var(--light-gray);">No pending KYC requests</p>
                </div>
            </div>

            <!-- User Management -->
            <div id="user-management" class="admin-section admin-card" style="display: none;">
                <h3 style="color: var(--primary-red); margin-bottom: 20px;">👥 User Management</h3>
                <div id="user-list">
                    <p style="text-align: center; padding: 40px; color: var(--light-gray);">No users found</p>
                </div>
            </div>

            <!-- Ads Management -->
            <div id="ads-management" class="admin-section admin-card" style="display: none;">
                <h3 style="color: var(--primary-red); margin-bottom: 20px;">📺 Ads Management</h3>
                <div class="form-group">
                    <label>Add YouTube Video URL</label>
                    <input type="text" class="form-control" id="youtube-url" placeholder="https://youtube.com/watch?v=...">
                </div>
                <button class="btn btn-primary" onclick="addVideo()">Add Video as Task</button>
                
                <div style="margin-top: 30px;">
                    <h4>Current Active Tasks</h4>
                    <div id="ads-list">
                        <p style="text-align: center; padding: 20px; color: var(--light-gray);">No active ads</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Withdrawal Modal -->
    <div id="withdraw-modal" class="page form-container" style="display: none;">
        <h2 class="form-title">Withdraw Funds</h2>
        <div class="form-group">
            <label>Amount (Minimum: $5)</label>
            <input type="number" class="form-control" id="withdraw-amount" min="5" step="0.01" required>
        </div>
        <div class="form-group">
            <label>Payment Method</label>
            <select class="form-control" id="withdraw-method" required>
                <option value="">Select Method</option>
                <option value="paypal">PayPal</option>
                <option value="binance">Binance</option>
                <option value="mpesa">M-Pesa</option>
                <option value="airtel">Airtel Money</option>
            </select>
        </div>
        <button class="btn btn-primary btn-3d" style="width: 100%;" onclick="submitWithdrawal()">
            Submit Withdrawal
        </button>
        <p style="text-align: center; margin-top: 20px;">
            <a href="#" style="color: var(--primary-red);" onclick="closeWithdrawModal()">
                ← Cancel
            </a>
        </p>
    </div>

    <script>
        // ==================== FIXED FIREBASE CONFIGURATION ====================
        // Using a more compatible Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDOKJQayF5j5xCp6LVZEEFFJH0QiQtezgg",
            authDomain: "ysm-platform-6ef20.firebaseapp.com",
            projectId: "ysm-platform-6ef20",
            storageBucket: "ysm-platform-6ef20.appspot.com",
            messagingSenderId: "485407332553",
            appId: "1:485407332553:web:77bd1bf2b3146486e51518"
        };

        // Initialize Firebase with error handling
        let db, auth, storage;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
            storage = firebase.storage();
            
            // Enable offline persistence for Firestore
            db.enablePersistence().catch((err) => {
                console.log('Firestore persistence failed: ', err);
            });
            
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error("Firebase initialization error:", error);
            // Fallback: Initialize with mock services
            initializeMockServices();
        }

        // ==================== MOCK SERVICES FOR OFFLINE DEVELOPMENT ====================
        function initializeMockServices() {
            console.log("Initializing mock services for offline development");
            
            // Mock Firestore
            db = {
                collection: (name) => ({
                    doc: (id) => ({
                        get: () => Promise.resolve({ exists: false, data: () => null }),
                        set: (data) => {
                            console.log('Mock Firestore: Setting document', id, data);
                            // Store in localStorage for persistence
                            const key = `firestore_${name}_${id}`;
                            localStorage.setItem(key, JSON.stringify(data));
                            return Promise.resolve();
                        },
                        update: (data) => {
                            console.log('Mock Firestore: Updating document', id, data);
                            const key = `firestore_${name}_${id}`;
                            const existing = JSON.parse(localStorage.getItem(key) || '{}');
                            localStorage.setItem(key, JSON.stringify({...existing, ...data}));
                            return Promise.resolve();
                        }
                    }),
                    add: (data) => {
                        const id = 'mock_' + Date.now();
                        console.log('Mock Firestore: Adding document', id, data);
                        const key = `firestore_${name}_${id}`;
                        localStorage.setItem(key, JSON.stringify(data));
                        return Promise.resolve({ id });
                    },
                    where: () => ({
                        get: () => Promise.resolve({ empty: true, forEach: () => {} })
                    }),
                    get: () => Promise.resolve({ empty: true, forEach: () => {} })
                })
            };

            // Mock Auth
            auth = {
                currentUser: null,
                onAuthStateChanged: (callback) => {
                    // Check if user exists in localStorage
                    const userData = localStorage.getItem('currentUser');
                    if (userData) {
                        auth.currentUser = JSON.parse(userData);
                        callback(auth.currentUser);
                    } else {
                        callback(null);
                    }
                    return () => {}; // unsubscribe function
                },
                createUserWithEmailAndPassword: (email, password) => {
                    const user = {
                        uid: 'user_' + Date.now(),
                        email: email,
                        displayName: document.getElementById('reg-name')?.value || 'User'
                    };
                    auth.currentUser = user;
                    localStorage.setItem('currentUser', JSON.stringify(user));
                    return Promise.resolve({ user });
                },
                signInWithEmailAndPassword: (email, password) => {
                    // For demo purposes, accept any email/password
                    const user = {
                        uid: 'user_' + Date.now(),
                        email: email,
                        displayName: 'Demo User'
                    };
                    auth.currentUser = user;
                    localStorage.setItem('currentUser', JSON.stringify(user));
                    return Promise.resolve({ user });
                },
                signOut: () => {
                    auth.currentUser = null;
                    localStorage.removeItem('currentUser');
                    return Promise.resolve();
                }
            };

            // Mock Storage
            storage = {
                ref: (path) => ({
                    put: (file) => {
                        console.log('Mock Storage: Uploading file', path, file.name);
                        // Create a mock download URL
                        const mockUrl = URL.createObjectURL(file);
                        return Promise.resolve({
                            ref: {
                                getDownloadURL: () => Promise.resolve(mockUrl)
                            }
                        });
                    }
                })
            };
        }

        // ==================== APPLICATION STATE ====================
        let currentUser = null;

        // ==================== FIXED AUTH STATE LISTENER ====================
        if (auth) {
            auth.onAuthStateChanged(async (user) => {
                try {
                    if (user) {
                        console.log("User authenticated:", user.email);
                        currentUser = user;
                        
                        // Check if user document exists
                        const userRef = db.collection('users').doc(user.uid);
                        const doc = await userRef.get().catch(err => {
                            console.log('Firestore get failed, using mock data');
                            return { exists: false };
                        });
                        
                        if (!doc.exists) {
                            // Create user document
                            const userData = {
                                name: user.displayName || document.getElementById('reg-name')?.value || 'User',
                                email: user.email,
                                tier: '115.38',
                                kycStatus: 'unverified',
                                role: 'user',
                                balance: 0,
                                createdAt: new Date().toISOString()
                            };
                            
                            await userRef.set(userData).catch(err => {
                                console.log('Firestore set failed, storing locally');
                                // Store in localStorage as fallback
                                localStorage.setItem(`user_${user.uid}`, JSON.stringify(userData));
                            });
                        }
                        
                        // Route user based on role (simplified for demo)
                        if (user.email === 'admin@ysm.com') {
                            showPage('admin-dashboard');
                        } else {
                            // Check KYC status
                            const userData = doc.exists ? doc.data() : JSON.parse(localStorage.getItem(`user_${user.uid}`) || '{}');
                            if (userData.kycStatus === 'approved') {
                                showPage('user-dashboard');
                                loadUserDashboard();
                            } else if (userData.kycStatus === 'pending') {
                                showPage('kyc-pending-page');
                            } else {
                                showPage('kyc-page');
                            }
                        }
                    } else {
                        currentUser = null;
                        showPage('landing-page');
                    }
                } catch (err) {
                    console.error('Auth state error:', err);
                    // Fallback routing
                    if (user) {
                        showPage('user-dashboard');
                    } else {
                        showPage('landing-page');
                    }
                }
            });
        }

        // ==================== FIXED UI FUNCTIONS ====================
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.style.display = 'none';
            });
            document.getElementById(pageId).style.display = 'block';
            window.scrollTo(0, 0);
        }

        function showError(message) {
            alert('❌ ' + message);
        }

        function showSuccess(message) {
            alert('✅ ' + message);
        }

        // ==================== FIXED AUTHENTICATION FUNCTIONS ====================
        async function registerUser() {
            try {
                const name = document.getElementById('reg-name')?.value?.trim();
                const email = document.getElementById('reg-email')?.value?.trim();
                const password = document.getElementById('reg-password')?.value;
                
                if (!name || !email || !password) {
                    showError('Please fill all required fields');
                    return;
                }
                
                showLoading();
                
                await auth.createUserWithEmailAndPassword(email, password);
                
                showSuccess('Account created successfully! Please complete KYC verification.');
                showPage('kyc-page');
                
            } catch (err) {
                console.error('Registration error:', err);
                showError('Registration failed: ' + (err.message || 'Please try again'));
            } finally {
                hideLoading();
            }
        }

        async function loginUser() {
            try {
                const email = document.getElementById('login-email')?.value?.trim();
                const password = document.getElementById('login-password')?.value;
                
                if (!email || !password) {
                    showError('Please enter email and password');
                    return;
                }
                
                showLoading();
                await auth.signInWithEmailAndPassword(email, password);
                // Auth state listener will handle redirection
                
            } catch (err) {
                console.error('Login error:', err);
                showError('Login failed: ' + (err.message || 'Invalid credentials'));
            } finally {
                hideLoading();
            }
        }

        async function logout() {
            try {
                await auth.signOut();
                showPage('landing-page');
                showSuccess('Signed out successfully');
            } catch (error) {
                console.error('Logout error:', error);
                showError('Logout failed');
            }
        }

        // ==================== FIXED KYC FUNCTIONS ====================
        async function submitKYC() {
            try {
                const name = document.getElementById('kyc-name')?.value?.trim();
                const idType = document.getElementById('kyc-id-type')?.value;
                const idNumber = document.getElementById('kyc-id-number')?.value?.trim();
                
                if (!name || !idType || !idNumber) {
                    showError('Please complete all required fields');
                    return;
                }
                
                const user = auth.currentUser;
                if (!user) {
                    showError('Please log in again');
                    return;
                }
                
                showLoading();
                
                // Update user KYC status
                const userRef = db.collection('users').doc(user.uid);
                await userRef.update({
                    kycStatus: 'pending',
                    name: name
                }).catch(err => {
                    console.log('Firestore update failed, storing locally');
                    // Update local storage
                    const userData = JSON.parse(localStorage.getItem(`user_${user.uid}`) || '{}');
                    userData.kycStatus = 'pending';
                    userData.name = name;
                    localStorage.setItem(`user_${user.uid}`, JSON.stringify(userData));
                });
                
                showSuccess('KYC submitted for review! You will be notified when approved.');
                showPage('kyc-pending-page');
                
            } catch (err) {
                console.error('KYC submission error:', err);
                showError('KYC submission failed: ' + (err.message || 'Please try again'));
            } finally {
                hideLoading();
            }
        }

        // ==================== FIXED ADMIN FUNCTIONS ====================
        async function loginAdmin() {
            try {
                const username = document.getElementById('admin-username').value;
                const password = document.getElementById('admin-password').value;

                if (username === 'admin' && password === 'admin123') {
                    showLoading();
                    
                    // Use admin credentials
                    await auth.signInWithEmailAndPassword('admin@ysm.com', 'admin123');
                    
                    showSuccess('Admin login successful!');
                    showPage('admin-dashboard');
                    
                } else {
                    showError('Invalid admin credentials');
                }
            } catch (error) {
                console.error('Admin login error:', error);
                // For demo, allow admin login even if Firebase fails
                const mockAdmin = {
                    uid: 'admin',
                    email: 'admin@ysm.com',
                    displayName: 'Admin'
                };
                auth.currentUser = mockAdmin;
                localStorage.setItem('currentUser', JSON.stringify(mockAdmin));
                showSuccess('Admin login successful! (Offline Mode)');
                showPage('admin-dashboard');
            } finally {
                hideLoading();
            }
        }

        function loadAdminStats() {
            showAdminSection('admin-stats');
            // Mock data for demo
            document.getElementById('total-users').textContent = '25';
            document.getElementById('pending-kyc').textContent = '3';
            document.getElementById('total-earnings').textContent = '$1,250';
        }

        function loadKYCManagement() {
            showAdminSection('kyc-management');
            // Mock KYC data
            document.getElementById('kyc-list').innerHTML = `
                <div class="user-item">
                    <div>
                        <div style="font-weight: bold;">John Doe</div>
                        <div style="font-size: 0.9rem; color: var(--light-gray);">
                            john.doe@example.com • Passport • AB123456
                        </div>
                    </div>
                    <div>
                        <button class="btn btn-success" onclick="approveKYC('user1')">Approve</button>
                        <button class="btn btn-danger" onclick="rejectKYC('user1')">Reject</button>
                    </div>
                </div>
            `;
        }

        function loadUserManagement() {
            showAdminSection('user-management');
            // Mock user data
            document.getElementById('user-list').innerHTML = `
                <div class="user-item">
                    <div>
                        <div style="font-weight: bold;">John Doe</div>
                        <div style="font-size: 0.9rem; color: var(--light-gray);">
                            john.doe@example.com • Tier: $115.38 • KYC: approved
                        </div>
                    </div>
                    <div class="balance-control">
                        <input type="number" class="balance-input" value="50.00" step="0.01">
                        <button class="btn btn-primary" onclick="showSuccess('Balance updated!')">Update</button>
                    </div>
                </div>
            `;
        }

        function loadAdsManagement() {
            showAdminSection('ads-management');
            // Mock ads data
            document.getElementById('ads-list').innerHTML = `
                <div class="user-item">
                    <div>
                        <div style="font-weight: bold;">Sample Video Task</div>
                        <div style="font-size: 0.9rem; color: var(--light-gray);">
                            Video ID: dQw4w9WgXcQ
                        </div>
                    </div>
                    <div>
                        <button class="btn btn-danger" onclick="showSuccess('Ad deactivated!')">Deactivate</button>
                    </div>
                </div>
            `;
        }

        function addVideo() {
            const url = document.getElementById('youtube-url').value;
            if (url) {
                showSuccess('Video added as task!');
                document.getElementById('youtube-url').value = '';
            } else {
                showError('Please enter a YouTube URL');
            }
        }

        function approveKYC(userId) {
            showSuccess('KYC approved! User can now earn money.');
            loadKYCManagement();
        }

        function rejectKYC(userId) {
            showSuccess('KYC rejected! User must resubmit documents.');
            loadKYCManagement();
        }

        function showAdminSection(sectionId) {
            document.querySelectorAll('.admin-section').forEach(section => {
                section.style.display = 'none';
            });
            document.getElementById(sectionId).style.display = 'block';
        }

        // ==================== FIXED USER DASHBOARD FUNCTIONS ====================
        function loadUserDashboard() {
            if (!currentUser) return;
            
            // Mock user data
            document.getElementById('user-display-name').textContent = currentUser.displayName || 'User';
            document.getElementById('user-avatar').textContent = (currentUser.displayName || 'U').charAt(0).toUpperCase();
            document.getElementById('user-balance').textContent = '$50.00';
            document.getElementById('user-pending').textContent = '$25.00';
            document.getElementById('user-referral').textContent = '$10.00';
            document.getElementById('user-tier-display').textContent = '$115.38 Tier';
            document.getElementById('kyc-status').textContent = 'approved';
            document.getElementById('kyc-status').className = 'badge badge-approved';
        }

        function startTask(taskId) {
            showSuccess('Task started! Watch the video to earn money.');
        }

        function showWithdrawModal() {
            document.getElementById('withdraw-modal').style.display = 'block';
        }

        function closeWithdrawModal() {
            document.getElementById('withdraw-modal').style.display = 'none';
        }

        function submitWithdrawal() {
            showSuccess('Withdrawal request submitted!');
            closeWithdrawModal();
        }

        function toggleNotifications() {
            showSuccess('Notifications feature coming soon!');
        }

        // ==================== UTILITY FUNCTIONS ====================
        function showDashboardSection(section) {
            showSuccess(`${section.charAt(0).toUpperCase() + section.slice(1)} section coming soon!`);
        }

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize file upload labels
            const fileInputs = {
                'kyc-front': 'front-file-name',
                'kyc-back': 'back-file-name', 
                'kyc-selfie': 'selfie-file-name',
                'kyc-address': 'address-file-name'
            };
            
            Object.keys(fileInputs).forEach(inputId => {
                const input = document.getElementById(inputId);
                const label = document.getElementById(fileInputs[inputId]);
                if (input && label) {
                    input.addEventListener('change', function(e) {
                        const file = e.target.files[0];
                        if (file) {
                            label.textContent = file.name;
                        }
                    });
                }
            });
            
            console.log('YSM Platform initialized successfully');
            
            // Show offline warning if needed
            if (!navigator.onLine) {
                console.warn('Running in offline mode');
            }
        });

    </script>
</body>
</html>
